
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Exported Map</title>
  <style>
    body, html { 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      font-family: Arial, sans-serif; 
    }
    #container { 
      width: 100vw; 
      height: 100vh; 
    }
    /* ÏÇ¨Ïù¥ÎìúÎ∞î Ïä§ÌÉÄÏùº */
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 220px;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      border-right: 1px solid #ccc;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
      transition: transform 0.3s ease;
      z-index: 5;
    }
    #sidebar.hidden {
      transform: translateX(-220px);
    }
    #toggle-sidebar {
      position: absolute;
      top: 10px;
      left: 230px;
      z-index: 1;
      padding: 5px 10px;
      background:rgb(64, 153, 217);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #shelf-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #shelf-list li {
      padding: 5px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #shelf-list li.highlight {
      background:rgb(244, 122, 122);
    }
  </style>
<script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.173.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.173.0/examples/jsm/"
    }
  }
</script>
</head>
<body>
  <div id="sidebar">
    <h3>Shelf List</h3>
    <ul id="shelf-list"></ul>
  </div>
  <button id="toggle-sidebar">üîç</button>
  <div id="container"></div>
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const exportedData = {"storeMap":{"width":0,"depth":0},"objects":[{"type":"Shelf","id":"obj_13","width":6,"height":1.5,"depth":3,"color":"ecf7fe","position":{"x":6,"y":0.75,"z":-5},"rotation":{"x":0,"y":6.283185307179586,"z":0},"label":"Ïù¥ÌòÑÏÑùG"},{"type":"Shelf","id":"obj_6","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":0,"y":0.75,"z":-2},"rotation":{"x":0,"y":0,"z":0},"label":"ÍπÄÎèôÌòÑ"},{"type":"Shelf","id":"obj_8","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":-6,"y":0.75,"z":5},"rotation":{"x":0,"y":6.283185307179586,"z":0},"label":"ÍπÄÏÜåÌòÑ"},{"type":"Shelf","id":"obj_12","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":0,"y":0.75,"z":-5},"rotation":{"x":0,"y":6.283185307179586,"z":0},"label":"Î∞ïÌï¥ÏõÖ"},{"type":"Shelf","id":"obj_5","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":-6,"y":0.75,"z":-2},"rotation":{"x":0,"y":0,"z":0},"label":"ÏÑúÎ™ÖÏù∏"},{"type":"Shelf","id":"obj_15","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":0,"y":0.75,"z":-12},"rotation":{"x":0,"y":0,"z":0},"label":"Ïã†ÌòïÏÑ≠"},{"type":"Shelf","id":"obj_21","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":-12,"y":0.75,"z":-5},"rotation":{"x":0,"y":6.283185307179586,"z":0},"label":"Ïó¨ÎèôÌòë"},{"type":"Shelf","id":"obj_11","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":-6,"y":0.75,"z":-5},"rotation":{"x":0,"y":6.283185307179586,"z":0},"label":"Ïù¥ÏäπÌôò"},{"type":"Shelf","id":"obj_9","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":0,"y":0.75,"z":5},"rotation":{"x":0,"y":6.283185307179586,"z":0},"label":"Ïù¥Ïö¥Ïã¨"},{"type":"Shelf","id":"obj_7","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":6,"y":0.75,"z":-2},"rotation":{"x":0,"y":0,"z":0},"label":"Ïù¥Ï∞ΩÏö∞"},{"type":"Shelf","id":"obj_14","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":-6,"y":0.75,"z":-12},"rotation":{"x":0,"y":0,"z":0},"label":"Ïû•Í∏∞ÌòÑ"},{"type":"Shelf","id":"obj_17","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":-12,"y":0.75,"z":-2},"rotation":{"x":0,"y":0,"z":0},"label":"STI"},{"type":"Shelf","id":"obj_18","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":-18,"y":0.75,"z":-2},"rotation":{"x":0,"y":0,"z":0},"label":"STI"},{"type":"Shelf","id":"obj_19","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":-12,"y":0.75,"z":5},"rotation":{"x":0,"y":6.283185307179586,"z":0},"label":"STI"},{"type":"Shelf","id":"obj_20","width":6,"height":1.5,"depth":3,"color":"bababa","position":{"x":-18,"y":0.75,"z":5},"rotation":{"x":0,"y":6.283185307179586,"z":0},"label":"STI"},{"type":"Shelf","id":"obj_22","width":6,"height":1.5,"depth":3,"color":"d9d9d9","position":{"x":-18,"y":0.75,"z":-5},"rotation":{"x":0,"y":3.141592653589793,"z":0},"label":"  "},{"type":"Shelf","id":"obj_23","width":6,"height":1.5,"depth":3,"color":"d9d9d9","position":{"x":-12,"y":0.75,"z":-12},"rotation":{"x":0,"y":0,"z":0},"label":"    "},{"type":"Shelf","id":"obj_24","width":6,"height":1.5,"depth":3,"color":"d9d9d9","position":{"x":-18,"y":0.75,"z":-12},"rotation":{"x":0,"y":0,"z":0},"label":"    "},{"type":"Shelf","id":"obj_27","width":30,"height":2.1,"depth":0.1,"color":"808080","position":{"x":-6.024632241442928,"y":1.5,"z":-3.5603862895646152},"rotation":{"x":0,"y":0,"z":0},"label":"  "},{"type":"Shelf","id":"obj_28","width":24,"height":3,"depth":0.1,"color":"808080","position":{"x":-8.98943901384613,"y":1.5,"z":6.517645291743363},"rotation":{"x":0,"y":0,"z":0},"label":"  "},{"type":"Shelf","id":"obj_29","width":24,"height":3,"depth":0.1,"color":"808080","position":{"x":-8.970381614809398,"y":1.5,"z":-13.534634919294962},"rotation":{"x":0,"y":0,"z":0},"label":"  "},{"type":"Shelf","id":"obj_30","width":6,"height":3,"depth":0.1,"color":"bababa","position":{"x":-20.960425459722796,"y":1.5,"z":-3.5236116996890217},"rotation":{"x":0,"y":1.5707963267948966,"z":0},"label":"  "},{"type":"Shelf","id":"obj_31","width":6,"height":3,"depth":0.1,"color":"bababa","position":{"x":9.051531162664714,"y":1.5,"z":-3.4841619592030533},"rotation":{"x":0,"y":1.5707963267948966,"z":0},"label":"  "},{"type":"Shelf","id":"obj_32","width":3,"height":3,"depth":0.1,"color":"bababa","position":{"x":-20.962784848013804,"y":1.5,"z":5.071429598331592},"rotation":{"x":0,"y":1.5707963267948966,"z":0},"label":"  "},{"type":"Shelf","id":"obj_33","width":3,"height":3,"depth":0.1,"color":"bababa","position":{"x":3.09531162736768,"y":1.5,"z":4.990607794787238},"rotation":{"x":0,"y":1.5707963267948966,"z":0},"label":"  "},{"type":"Shelf","id":"obj_34","width":3,"height":3,"depth":0.1,"color":"bababa","position":{"x":3.0937143141987513,"y":1.5,"z":-11.966276468061176},"rotation":{"x":0,"y":1.5707963267948966,"z":0},"label":"  "},{"type":"Shelf","id":"obj_35","width":3,"height":3,"depth":0.1,"color":"bababa","position":{"x":-20.98616646521253,"y":1.5,"z":-12.022948815964261},"rotation":{"x":0,"y":1.5707963267948966,"z":0},"label":"  "},{"type":"Tile","id":"obj_50","width":35,"height":0.05,"depth":25,"color":"fcfcfc","position":{"x":-4.747771110445868,"y":0.025,"z":-3.311201293447361},"rotation":{"x":0,"y":0,"z":0},"label":"  "},{"type":"Shelf","id":"obj_51","width":25,"height":3,"depth":0.01,"color":"e5f9ff","position":{"x":12.776497958937524,"y":1.5,"z":-3.3728162421855963},"rotation":{"x":0,"y":1.5707963267948966,"z":0},"label":"  "},{"type":"Tile","id":"obj_54","width":5,"height":0.08,"depth":5,"color":"ffffff","position":{"x":8.599042135654164,"y":0.04,"z":4.995869787108831},"rotation":{"x":0,"y":0,"z":0},"label":"APP G"}]};

    let scene, camera, renderer, controls;
    init();
    animate();
    createShelfList();

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf0f0f0);

      // Ambient Light: Î∞ùÏùÄ Ìù∞ÏÉâ, Ï†ÅÎãπÌïú Í∞ïÎèÑÎ°ú Ï†ÑÏ≤¥Ï†ÅÏù∏ Ï°∞Î™Ö Î≥¥Í∞ï
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      // Directional Light: Ìù∞ÏÉâ, Í∞ïÎèÑÎ•º ÏïΩÍ∞Ñ ÎÜíÏó¨ÏÑú Ï£º Ï°∞Î™Ö Ïó≠Ìï† ÏàòÌñâ
      const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
      dirLight.position.set(10, 30, 10);
      scene.add(dirLight);

      // Hemisphere Light: ÏúÑÏ™ΩÍ≥º ÏïÑÎûòÏ™Ω ÎπõÏùò ÏÉâÏÉÅÏùÑ Îã§Î•¥Í≤å Ï£ºÏñ¥ ÏûêÏó∞Ïä§Îü¨Ïö¥ Ìö®Í≥º Ïó∞Ï∂ú
      const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
      hemiLight.position.set(0, 20, 0);
      scene.add(hemiLight);


      camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(30, 30, 30);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('container').appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.25;
      controls.minDistance = 10;
      controls.maxDistance = 100;

      // Îß§Ïû• ÏòÅÏó≠ Ïû¨Íµ¨ÏÑ±
      if (exportedData.storeMap) {
         const geometry = new THREE.PlaneGeometry(exportedData.storeMap.width, exportedData.storeMap.depth);
         const material = new THREE.MeshBasicMaterial({ color: 0xdddddd, side: THREE.DoubleSide });
         const floor = new THREE.Mesh(geometry, material);
         floor.rotation.x = -Math.PI / 2;
         scene.add(floor);
      }

      // Í∞ùÏ≤¥ Ïû¨Íµ¨ÏÑ± (Ïô∏Í≥ΩÏÑ† Î∞è ÎùºÎ≤® Ìè¨Ìï®)
      exportedData.objects.forEach(data => {
         let obj;
         if (data.type === "Shelf" || data.type === "Tile") {
           obj = new THREE.Mesh(
             new THREE.BoxGeometry(data.width, data.height, data.depth),
             new THREE.MeshLambertMaterial({ color: "#" + data.color })
           );
         }
         if (obj) {
            obj.position.set(data.position.x, data.position.y, data.position.z);
            if (data.rotation) {
                obj.rotation.set(data.rotation.x, data.rotation.y, data.rotation.z);
            }
            // userDataÏóê idÏôÄ type Ï†ÄÏû• (Î™©Î°ù Îß§Ïπ≠Ïö©)
            obj.userData.id = data.id;
            obj.userData.type = data.type;
            obj.name = data.id;
            scene.add(obj);
            addOutline(obj);
            attachLabel(obj, data.label);
         }
      });

      window.addEventListener('resize', onWindowResize, false);
      //renderer.domElement.addEventListener('click', onSceneClick);
      document.getElementById('toggle-sidebar').addEventListener('click', toggleSidebar);
    }

    // Ïô∏Í≥ΩÏÑ†ÏùÑ Ï∂îÍ∞ÄÌïòÎäî Ìï®Ïàò (ÌÉÄÏùºÏùÄ Ï†úÏô∏)
    function addOutline(object) {
      if (object.userData && object.userData.type === "Tile") return;
      const edges = new THREE.EdgesGeometry(object.geometry);
      const lineMaterial = new THREE.LineBasicMaterial({ color: 0x000000 });
      const outline = new THREE.LineSegments(edges, lineMaterial);
      object.add(outline);
    }

    // ÎùºÎ≤® Î∂ÄÏ∞© Ìï®Ïàò (Ï∫îÎ≤ÑÏä§ ÌÖçÏä§Ï≤ò ÏÇ¨Ïö©)
    function attachLabel(object, text) {
      const width = object.geometry.parameters.width || 1;
      const height = object.geometry.parameters.height || 1;
      const canvas = document.createElement('canvas');
      canvas.width = 256;
      canvas.height = 64;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.font = "48px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "black";
      ctx.fillText(text, canvas.width / 2, canvas.height / 2);
      const texture = new THREE.CanvasTexture(canvas);
      const planeGeometry = new THREE.PlaneGeometry(width, 0.5);
      const planeMaterial = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
      const labelMesh = new THREE.Mesh(planeGeometry, planeMaterial);
      labelMesh.raycast = () => {}; // ÎùºÎ≤®ÏùÄ raycast ÎåÄÏÉÅÏóêÏÑú Ï†úÏô∏
      labelMesh.position.set(0, height / 2 + 0.01, 0);
      labelMesh.rotation.x = -Math.PI / 2;
      object.add(labelMesh);
      // userDataÏóê ÎùºÎ≤® ÌÖçÏä§Ìä∏ Ï†ÄÏû• (Ïù¥ÌõÑ Î™©Î°ùÏóê ÏÇ¨Ïö©)
      object.userData.label = text;
    }

    function onWindowResize(){
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    // ÏÇ¨Ïù¥ÎìúÎ∞îÏùò Shelf Î™©Î°ù ÏÉùÏÑ±
    function createShelfList() {
      const shelfListEl = document.getElementById('shelf-list');
      shelfListEl.innerHTML = "";
      exportedData.objects.forEach(data => {
        if (data.type === "Shelf") {
          const li = document.createElement('li');
          li.textContent = data.label || "Shelf";
          li.dataset.id = data.id;
          li.addEventListener('click', () => {
              const shelfObj = scene.getObjectByName(data.id);
              if (shelfObj) {
                  focusOnObject(shelfObj);
                  flashObject(shelfObj);
                  flashListItem(li);
              }
          });
          shelfListEl.appendChild(li);
        }
      });
    }

    // Ïî¨ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏: Shelf ÌÅ¥Î¶≠ Ïãú ÏÇ¨Ïù¥Îìú Î™©Î°ùÍ≥º Ïó∞Îèô
    function onSceneClick(event) {
      const rect = renderer.domElement.getBoundingClientRect();
      const mouse = new THREE.Vector2();
      mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
      const raycaster = new THREE.Raycaster();
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(scene.children, true);
      if (intersects.length > 0) {
         let obj = intersects[0].object;
         while (obj && !obj.userData.id && obj.parent) {
            obj = obj.parent;
         }
         if (obj && obj.userData && obj.userData.type === "Shelf") {
            const listItem = document.querySelector(`#shelf-list li[data-id="${obj.userData.id}"]`);
            if (listItem) {
                flashListItem(listItem);
            }
            focusOnObject(obj);
            flashObject(obj);
         }
      }
    }

    // Ïπ¥Î©îÎùºÎ•º Ìï¥Îãπ Í∞ùÏ≤¥Î°ú Ìè¨Ïª§Ïä§
    function focusOnObject(obj) {
      controls.target.copy(obj.position);
      camera.position.set(obj.position.x, obj.position.y + 50, obj.position.z);
      controls.update();
    }


    function flashObject(obj) {
    // If there's an active timeout, clear it and restore original color first
    if (obj.userData.flashTimeout) {
        clearTimeout(obj.userData.flashTimeout);
        obj.material.color.set(obj.userData.originalColor);
    } else {
        // Store the original color in userData if not already set
        obj.userData.originalColor = obj.material.color.getHex();
    }
    // Highlight
    obj.material.color.set(0xf47a7a);
    
    // Set a new timeout
    obj.userData.flashTimeout = setTimeout(() => {
        obj.material.color.set(obj.userData.originalColor);
        delete obj.userData.flashTimeout;
    }, 1000);
    }

    function flashListItem(li) {
    // If there's an active timer, clear it first
    if (li.flashTimer) {
        clearTimeout(li.flashTimer);
        li.classList.remove("highlight");
    }
    li.classList.add("highlight");
    li.scrollIntoView({ behavior: "smooth", block: "center" });
    
    li.flashTimer = setTimeout(() => {
        li.classList.remove("highlight");
        li.flashTimer = null;
    }, 1000);
    }


    // ÏÇ¨Ïù¥ÎìúÎ∞î ÌÜ†Í∏Ä
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle("hidden");
    }
  </script>
</body>
</html>
